<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker ZAR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --in: #16a34a; --out: #dc2626; --accent: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-top: 80px; }
        .search-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .flex-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .tab-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; }
        .tab-btn.active-in { background: var(--in); color: white; }
        .tab-btn.active-out { background: var(--out); color: white; }
        .btn-process { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-sm { padding: 8px; font-size: 12px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; background: white; }
        .btn-export { width: 100%; background: #1e293b; color: white; padding: 12px; border-radius: 10px; border: none; font-weight: bold; margin-top: 10px; }
        #ocrStatus { font-size: 12px; font-weight: bold; margin-top: 5px; color: var(--accent); }
        .progress-bar { height: 4px; width: 0%; background: var(--accent); transition: width 0.3s; border-radius: 2px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        td { padding: 10px 0; border-top: 1px solid #f1f5f9; vertical-align: middle; }
        .del-icon { color: #cbd5e1; cursor: pointer; padding: 5px; font-size: 16px; text-align: right; }
        .view-btn { background: #f1f5f9; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }
        #imgModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        #imgModal img { max-width: 95%; max-height: 85%; border-radius: 8px; }
        .chip { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 11px; margin: 2px; display: inline-flex; align-items: center; gap: 5px; }
        .chip-del { color: var(--out); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'"><img id="modalImg" src=""></div>

<div class="search-header">
    <input type="text" id="searchInput" placeholder="üîç Search History..." onkeyup="renderApp()">
</div>

<div class="card">
    <div class="tab-group">
        <button id="tabIn" class="tab-btn active-in" onclick="setEntryMode('in')">Money In</button>
        <button id="tabOut" class="tab-btn" onclick="setEntryMode('out')">Money Out</button>
    </div>
    
    <div class="flex-row">
        <div class="form-group" style="flex: 2;"><label>Month</label><select id="entryMonth"></select></div>
        <div class="form-group" style="flex: 1;"><label>Day</label><select id="entryDay"></select></div>
    </div>

    <div class="form-group">
        <label>Scan Slip / Screenshot</label>
        <input type="file" id="cameraInput" accept="image/*">
        <div id="ocrStatus">Ready</div>
        <div id="pBarWrap" style="background:#e2e8f0; width:100%; height:4px; margin-top:5px; display:none;">
            <div id="pBar" class="progress-bar"></div>
        </div>
        <div style="margin-top:10px; font-size:12px;">
            <input type="checkbox" id="storeImgToggle" checked> Save Image
        </div>
    </div>

    <div class="form-group"><label>Amount (R)</label><input type="number" id="entryAmount" step="0.01"></div>
    
    <div id="outOnlyFields" style="display:none;">
        <div class="form-group"><label>Category</label><select id="entryCategory"></select></div>
        <div class="form-group"><label>Supplier</label><select id="entrySupplier"></select></div>
    </div>
    
    <button class="btn-process" onclick="processEntry()">SAVE TRANSACTION</button>
</div>

<div class="card">
    <h3>Recent History</h3>
    <table><tbody id="historyBody"></tbody></table>
</div>

<div class="card">
    <button class="btn-export" onclick="exportData()">üíæ DOWNLOAD EXCEL (CSV)</button>
    <button class="btn-sm" style="width:100%; margin-top:10px; color:var(--out);" onclick="clearAllData()">üóëÔ∏è DELETE ALL DATA</button>
</div>

<div class="card" style="border: 2px solid var(--accent);">
    <label>Manage Menu Items</label>
    <div class="flex-row">
        <input type="text" id="newItemName" placeholder="Name...">
        <button class="btn-sm" onclick="addItem('cats')">+ Cat</button>
        <button class="btn-sm" onclick="addItem('sups')">+ Sup</button>
    </div>
    <div id="listCats"></div><br>
    <div id="listSups"></div>
</div>

<script>
    let mode = 'in';
    let currentImgBase64 = null;
    let records = JSON.parse(localStorage.getItem('f_data')) || [];
    let cats = JSON.parse(localStorage.getItem('f_cats')) || ['Salary', 'Groceries', 'Petrol'];
    let sups = JSON.parse(localStorage.getItem('f_sups')) || ['Employer', 'Checkers', 'Shell'];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    // Initialization
    function initSelectors() {
        const mSel = document.getElementById('entryMonth');
        mSel.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
        mSel.value = new Date().getMonth();

        const dSel = document.getElementById('entryDay');
        dSel.innerHTML = Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
        dSel.value = new Date().getDate();
        
        renderApp();
    }

    function setEntryMode(m) {
        mode = m;
        document.getElementById('tabIn').className = m === 'in' ? 'tab-btn active-in' : 'tab-btn';
        document.getElementById('tabOut').className = m === 'out' ? 'tab-btn active-out' : 'tab-btn';
        document.getElementById('outOnlyFields').style.display = m === 'out' ? 'block' : 'none';
    }

    function processEntry() {
        const amt = parseFloat(document.getElementById('entryAmount').value);
        if(!amt) return alert("Enter amount");
        
        const cat = mode === 'out' ? document.getElementById('entryCategory').value : 'Income';
        const sup = mode === 'out' ? document.getElementById('entrySupplier').value : 'N/A';

        records.push({
            id: Date.now(), type: mode, 
            month: parseInt(document.getElementById('entryMonth').value), 
            day: parseInt(document.getElementById('entryDay').value),
            amount: amt, category: cat, supplier: sup,
            img: document.getElementById('storeImgToggle').checked ? currentImgBase64 : null,
            timestamp: Date.now()
        });
        
        // SMART MEMORY: Save choices for next time
        localStorage.setItem('last_cat', cat);
        localStorage.setItem('last_sup', sup);

        localStorage.setItem('f_data', JSON.stringify(records));
        
        // Reset only amount and image
        document.getElementById('entryAmount').value = '';
        currentImgBase64 = null;
        document.getElementById('ocrStatus').innerText = 'Ready';
        document.getElementById('pBarWrap').style.display = 'none';
        
        renderApp();
        alert("Saved!");
    }

    function renderApp() {
        // Build Selectors
        document.getElementById('entryCategory').innerHTML = cats.map(c => `<option>${c}</option>`).join('');
        document.getElementById('entrySupplier').innerHTML = sups.map(s => `<option>${s}</option>`).join('');
        
        // Apply Smart Memory
        if(localStorage.getItem('last_cat')) document.getElementById('entryCategory').value = localStorage.getItem('last_cat');
        if(localStorage.getItem('last_sup')) document.getElementById('entrySupplier').value = localStorage.getItem('last_sup');

        document.getElementById('listCats').innerHTML = cats.map((c, i) => `<span class="chip">${c} <span class="chip-del" onclick="removeItem('cats', ${i})">√ó</span></span>`).join('');
        document.getElementById('listSups').innerHTML = sups.map((s, i) => `<span class="chip">${s} <span class="chip-del" onclick="removeItem('sups', ${i})">√ó</span></span>`).join('');

        const q = document.getElementById('searchInput').value.toLowerCase();
        let displayList = q ? records.filter(r => r.supplier.toLowerCase().includes(q) || r.category.toLowerCase().includes(q)) : [...records].sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
        
        document.getElementById('historyBody').innerHTML = displayList.map(r => `
            <tr>
                <td>${r.day} ${months[r.month]}</td>
                <td>${r.supplier}</td>
                <td style="color:${r.type=='in'?'var(--in)':'var(--out)'}">R${r.amount.toFixed(2)}</td>
                <td>${r.img ? `<button class="view-btn" onclick="viewImg(${r.id})">VIEW</button>` : ''}</td>
                <td class="del-icon" onclick="deleteRecord(${r.id})">üóëÔ∏è</td>
            </tr>
        `).join('');
    }

    function exportData() {
        if (records.length === 0) return alert("No data");
        let csv = "Date,Type,Supplier,Category,Amount\n";
        records.forEach(r => csv += `${r.day} ${months[r.month]},${r.type.toUpperCase()},${r.supplier},${r.category},${r.amount.toFixed(2)}\n`);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `Report_${months[new Date().getMonth()]}.csv`;
        a.click();
    }

    function clearAllData() {
        if(confirm("Wipe everything? This cannot be undone!")) {
            records = [];
            localStorage.setItem('f_data', JSON.stringify(records));
            renderApp();
        }
    }

    async function resizeImage(file) {
        return new Promise((res) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 400 / img.width;
                    canvas.width = 400; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    res(canvas.toDataURL('image/jpeg', 0.5));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    document.getElementById('cameraInput').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        currentImgBase64 = await resizeImage(file);
        const status = document.getElementById('ocrStatus');
        const bar = document.getElementById('pBar');
        document.getElementById('pBarWrap').style.display = 'block';
        
        const worker = await Tesseract.createWorker({
            logger: m => { if(m.status === 'recognizing text') bar.style.width = Math.floor(m.progress * 100) + '%'; }
        });

        try {
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data: { text } } = await worker.recognize(file);
            const m = text.match(/\d+[\.,]\d{2}/g);
            if(m) document.getElementById('entryAmount').value = Math.max(...m.map(n => parseFloat(n.replace(',','.'))));
            
            // Auto-detect supplier from scan
            sups.forEach(s => { if(text.toUpperCase().includes(s.toUpperCase())) document.getElementById('entrySupplier').value = s; });
            
            status.innerText = "‚úÖ Scan Complete";
            await worker.terminate();
        } catch (err) { status.innerText = "‚ùå Scan Failed"; await worker.terminate(); }
    };

    function viewImg(id) {
        const r = records.find(x => x.id === id);
        if(r && r.img) { document.getElementById('modalImg').src = r.img; document.getElementById('imgModal').style.display = 'flex'; }
    }

    function addItem(type) {
        const val = document.getElementById('newItemName').value.trim();
        if(!val) return;
        if(type==='cats') cats.push(val); else sups.push(val);
        localStorage.setItem('f_'+type, JSON.stringify(type==='cats'?cats:sups));
        document.getElementById('newItemName').value = '';
        renderApp();
    }

    function removeItem(type, idx) {
        if(type==='cats') cats.splice(idx, 1); else sups.splice(idx, 1);
        localStorage.setItem('f_'+type, JSON.stringify(type==='cats'?cats:sups));
        renderApp();
    }

    function deleteRecord(id) {
        if(confirm("Delete?")) { records = records.filter(r => r.id !== id); localStorage.setItem('f_data', JSON.stringify(records)); renderApp(); }
    }

    initSelectors();
</script>
</body>
</html>
