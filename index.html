<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker ZAR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root { --in: #16a34a; --out: #dc2626; --accent: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-top: 70px; }
        .search-header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        label { display: block; font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        .btn-process { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .summary-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .s-card { padding: 10px; border-radius: 8px; background: #f8fafc; border-left: 4px solid #cbd5e1; }
        .s-card b { display: block; font-size: 14px; }
        .s-card span { font-size: 9px; color: #64748b; text-transform: uppercase; }
        .group-header { background: #e2e8f0; padding: 8px 12px; margin-top: 15px; border-radius: 6px; font-size: 11px; font-weight: 800; display: flex; justify-content: space-between; color: #475569; }
        .mini-table { width: 100%; font-size: 13px; border-collapse: collapse; background: white; }
        .mini-table td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; }
        .date-col { color: #64748b; font-weight: 600; font-size: 11px; width: 60px; }
    </style>
</head>
<body>

<div class="search-header">
    <input type="text" id="searchInput" placeholder="ðŸ” Search Suppliers..." onkeyup="renderApp()">
</div>

<div class="card">
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Year</label><select id="entryYear" onchange="renderApp()"></select></div>
        <div style="flex:1.5"><label>Month</label><select id="entryMonth" onchange="renderApp()"></select></div>
        <div style="flex:1"><label>Day</label><select id="entryDay"></select></div>
    </div>
    
    <label>Amount (R)</label>
    <input type="number" id="entryAmount" inputmode="decimal" placeholder="0.00">
    
    <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Supplier</label><select id="entrySupplier"></select></div>
        <div style="flex:1"><label>Category</label><select id="entryCategory"></select></div>
    </div>
    
    <button class="btn-process" onclick="processEntry()">SAVE TRANSACTION</button>
</div>

<div class="card">
    <label id="statsTitle">Insights</label>
    <div class="summary-box">
        <div class="s-card" style="border-left-color: var(--in);"><span>Month In</span><b id="statIn">R0</b></div>
        <div class="s-card" style="border-left-color: var(--out);"><span>Month Out</span><b id="statOut">R0</b></div>
    </div>
    <div style="font-size: 11px; color: #64748b; margin-top: 5px;" id="shopSpendingSummary"></div>
</div>

<div id="historyContainer"></div>

<script>
    let records = JSON.parse(localStorage.getItem('f_data')) || [];
    let cats = JSON.parse(localStorage.getItem('f_cats')) || ['Groceries', 'Petrol', 'Salary', 'Rent'];
    let sups = JSON.parse(localStorage.getItem('f_sups')) || ['Checkers', 'Shell', 'Employer', 'Woolworths'];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function init() {
        const yearSel = document.getElementById('entryYear');
        const curY = new Date().getFullYear();
        for(let i = 2024; i <= 2028; i++) yearSel.innerHTML += `<option value="${i}">${i}</option>`;
        yearSel.value = curY;

        document.getElementById('entryMonth').innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
        document.getElementById('entryMonth').value = new Date().getMonth();
        
        document.getElementById('entryDay').innerHTML = Array.from({length:31},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
        document.getElementById('entryDay').value = new Date().getDate();
        
        renderApp();
    }

    function processEntry() {
        const amt = parseFloat(document.getElementById('entryAmount').value);
        if(!amt) return;

        records.push({
            id: Date.now(),
            year: parseInt(document.getElementById('entryYear').value),
            month: parseInt(document.getElementById('entryMonth').value),
            day: parseInt(document.getElementById('entryDay').value),
            amount: amt,
            supplier: document.getElementById('entrySupplier').value,
            category: document.getElementById('entryCategory').value,
            type: document.getElementById('entryCategory').value === 'Salary' ? 'in' : 'out'
        });

        localStorage.setItem('f_data', JSON.stringify(records));
        document.getElementById('entryAmount').value = '';
        renderApp();
    }

    function renderApp() {
        document.getElementById('entryCategory').innerHTML = cats.map(c=>`<option>${c}</option>`).join('');
        document.getElementById('entrySupplier').innerHTML = sups.map(s=>`<option>${s}</option>`).join('');

        const selY = parseInt(document.getElementById('entryYear').value);
        const selM = parseInt(document.getElementById('entryMonth').value);
        
        document.getElementById('statsTitle').innerText = `${months[selM]} ${selY} Insights`;

        // 1. Filter by Year & Month for Stats
        const filteredRecords = records.filter(r => r.year === selY && r.month === selM);

        // 2. Calculate Stats
        const tin = filteredRecords.filter(r => r.type === 'in').reduce((s, r) => s + r.amount, 0);
        const tout = filteredRecords.filter(r => r.type === 'out').reduce((s, r) => s + r.amount, 0);
        
        document.getElementById('statIn').innerText = `R${tin.toFixed(2)}`;
        document.getElementById('statOut').innerText = `R${tout.toFixed(2)}`;

        // 3. Render Grouped History (Sorted by Supplier then Date)
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';

        let sorted = filteredRecords.sort((a, b) => {
            if (a.supplier !== b.supplier) return a.supplier.localeCompare(b.supplier);
            return a.day - b.day;
        });

        const q = document.getElementById('searchInput').value.toLowerCase();
        if(q) sorted = sorted.filter(r => r.supplier.toLowerCase().includes(q));

        if(sorted.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8; font-size:12px;">No records for ${months[selM]} ${selY}.</div>`;
            return;
        }

        let currentSup = ""; 
        let supTotal = 0
