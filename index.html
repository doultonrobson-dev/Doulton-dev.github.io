<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO-LOG Smart Cash-Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 flex justify-center">

    <div id="app" class="w-full max-w-md bg-slate-50 min-h-screen flex flex-col relative shadow-2xl">
        <!-- Header -->
        <header class="bg-white border-b p-5 flex justify-between items-center sticky top-0 z-50">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter text-slate-900">PRO-LOG</h1>
                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Business Intelligence</p>
            </div>
            <button onclick="document.getElementById('cameraInput').click()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest italic flex items-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                Scan Report
            </button>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        </header>

        <!-- Main UI -->
        <main class="flex-1 p-4 pb-32">
            <div class="flex bg-white p-1 rounded-2xl border border-slate-200 mb-4 shadow-sm">
                <button id="tabIncome" onclick="setEntryType('income')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase transition-all bg-green-600 text-white shadow-md">Income</button>
                <button id="tabExpense" onclick="setEntryType('expense')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase transition-all text-slate-400">Expense</button>
            </div>

            <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 space-y-5">
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Description</label>
                    <input id="descInput" class="w-full bg-slate-50 p-4 rounded-xl font-bold text-sm outline-none border-none focus:ring-2 focus:ring-slate-200" placeholder="Daily Sales">
                </div>

                <!-- Income Fields -->
                <div id="incomeFields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                            <label class="text-[9px] font-black text-blue-500 uppercase flex items-center gap-1">Yoko (Next to Text)</label>
                            <div class="flex items-center mt-1">
                                <span class="text-xs font-bold text-blue-600 mr-1">R</span>
                                <input type="number" id="yokoInput" oninput="updateTotal()" class="bg-transparent border-none p-0 font-black text-xl text-blue-900 w-full focus:ring-0" value="0.00">
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-2xl border border-green-100">
                            <label class="text-[9px] font-black text-green-500 uppercase flex items-center gap-1">Cash Calculation</label>
                            <div class="flex items-center mt-1 text-green-900 font-black text-xl">
                                <span class="text-xs mr-1">R</span>
                                <span id="cashDisplay">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-900 p-5 rounded-2xl flex justify-between items-center shadow-inner">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest underline decoration-blue-500/40">Grand Total (Arrow)</label>
                        <div class="flex items-center text-white font-black text-2xl tracking-tighter">
                            <span>R</span>
                            <input type="number" id="grandTotalInput" oninput="updateTotal()" class="bg-transparent border-none p-0 text-right w-32 focus:ring-0" value="0.00">
                        </div>
                    </div>
                </div>

                <!-- Expense Field -->
                <div id="expenseFields" class="hidden bg-red-50 p-4 rounded-2xl border border-red-100">
                    <label class="text-[9px] font-black text-red-500 uppercase">Total Invoice Amount</label>
                    <div class="flex items-center mt-1">
                        <span class="text-xs font-bold text-red-600 mr-1">R</span>
                        <input type="number" id="expenseAmount" class="bg-transparent border-none p-0 font-black text-2xl text-red-900 w-full focus:ring-0" value="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="dateInput" class="bg-slate-50 p-4 rounded-xl font-bold text-xs outline-none">
                    <select id="catInput" class="bg-slate-50 p-4 rounded-xl font-bold text-xs outline-none">
                        <option>Sales</option>
                        <option>Stock</option>
                        <option>Wages</option>
                        <option>Rent</option>
                    </select>
                </div>

                <button onclick="saveRecord()" id="btnSave" class="w-full py-5 rounded-2xl font-black text-white shadow-lg bg-blue-600 active:scale-95 transition-all">
                    SAVE INCOME
                </button>
            </div>

            <!-- List -->
            <div id="historyList" class="mt-8 space-y-2"></div>
        </main>

        <!-- Scanner Overlay -->
        <div id="scannerOverlay" class="hidden fixed inset-0 z-[100] bg-slate-950 flex flex-col p-6 text-white">
            <div class="flex justify-between items-center mb-4">
                <span class="text-[10px] font-black uppercase text-blue-500 tracking-widest italic">Scanning Ledger...</span>
                <button onclick="closeScanner()" class="p-2 bg-white/10 rounded-full">âœ•</button>
            </div>
            <div class="flex-1 bg-black rounded-3xl overflow-hidden border border-white/10 flex items-center justify-center">
                <img id="previewImg" class="max-h-full object-contain">
            </div>
            <button id="processBtn" onclick="processImage()" class="w-full mt-6 p-6 rounded-3xl bg-blue-600 font-black uppercase text-xs tracking-widest shadow-xl flex items-center justify-center gap-3">
                Extract Data
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pro-log-business-zar';
        const apiKey = ""; 

        let entryType = 'income';
        let records = [];
        let currentImageBase64 = '';

        // Auth
        auth.signInAnonymously().catch(console.error);

        // State UI
        function setEntryType(type) {
            entryType = type;
            const incBtn = document.getElementById('tabIncome');
            const expBtn = document.getElementById('tabExpense');
            const incF = document.getElementById('incomeFields');
            const expF = document.getElementById('expenseFields');
            const saveBtn = document.getElementById('btnSave');

            if (type === 'income') {
                incBtn.className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-green-600 text-white shadow-md";
                expBtn.className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase text-slate-400";
                incF.classList.remove('hidden');
                expF.classList.add('hidden');
                saveBtn.innerText = "SAVE INCOME";
                saveBtn.className = "w-full py-5 rounded-2xl font-black text-white shadow-lg bg-blue-600 active:scale-95 transition-all";
            } else {
                expBtn.className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-red-600 text-white shadow-md";
                incBtn.className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase text-slate-400";
                incF.classList.add('hidden');
                expF.classList.remove('hidden');
                saveBtn.innerText = "SAVE EXPENSE";
                saveBtn.className = "w-full py-5 rounded-2xl font-black text-white shadow-lg bg-red-600 active:scale-95 transition-all";
            }
        }

        function updateTotal() {
            const yoko = parseFloat(document.getElementById('yokoInput').value || 0);
            const total = parseFloat(document.getElementById('grandTotalInput').value || 0);
            document.getElementById('cashDisplay').innerText = (total - yoko).toFixed(2);
        }

        // Image Handling
        document.getElementById('cameraInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                currentImageBase64 = ev.target.result;
                document.getElementById('previewImg').src = ev.target.result;
                document.getElementById('scannerOverlay').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        };

        function closeScanner() {
            document.getElementById('scannerOverlay').classList.add('hidden');
        }

        async function processImage() {
            const btn = document.getElementById('processBtn');
            btn.innerText = "Reading Paper...";
            btn.disabled = true;

            const systemPrompt = `Analyze this paper slip.
            1. If it's a Daily Sales slip: Find "Yoko" and get the value next to it. Find the Grand Total (value at the bottom with a hand-drawn arrow pointing to it). Set type="income".
            2. If it's an Invoice: Get business name and total. Set type="expense".
            Return JSON: {"type": "income"|"expense", "supplier": "string", "yoko": number, "total": number, "date": "YYYY-MM-DD"}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: "Extract numbers from this slip." }, { inlineData: { mimeType: "image/jpeg", data: currentImageBase64.split(',')[1] } }]
                        }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const res = await response.json();
                const data = JSON.parse(res.candidates[0].content.parts[0].text);

                setEntryType(data.type);
                document.getElementById('descInput').value = data.supplier || (data.type === 'income' ? 'Daily Sales' : '');
                document.getElementById('yokoInput').value = data.yoko || 0;
                document.getElementById('grandTotalInput').value = data.total || 0;
                document.getElementById('expenseAmount').value = data.total || 0;
                if(data.date) document.getElementById('dateInput').value = data.date;
                
                updateTotal();
                closeScanner();
            } catch (e) {
                console.error(e);
                alert("Scan failed. Try again.");
            } finally {
                btn.innerText = "Extract Data";
                btn.disabled = false;
            }
        }

        // Firestore Ops
        async function saveRecord() {
            const desc = document.getElementById('descInput').value;
            const yoko = parseFloat(document.getElementById('yokoInput').value);
            const grandTotal = entryType === 'income' 
                ? parseFloat(document.getElementById('grandTotalInput').value)
                : parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('dateInput').value;
            const cat = document.getElementById('catInput').value;

            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('entries').add({
                supplier: desc,
                yokoAmount: yoko,
                totalAmount: grandTotal,
                date: date,
                category: cat,
                type: entryType,
                createdAt: new Date().toISOString()
            });

            document.getElementById('yokoInput').value = 0;
            document.getElementById('grandTotalInput').value = 0;
            document.getElementById('expenseAmount').value = 0;
            updateTotal();
        }

        // Fetch History
        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('entries')
            .orderBy('date', 'desc')
            .onSnapshot(snap => {
                const list = document.getElementById('historyList');
                list.innerHTML = '<h3 class="text-[10px] font-black uppercase text-slate-400 mb-2">Logged Entries</h3>';
                snap.forEach(doc => {
                    const r = doc.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm mb-2";
                    div.innerHTML = `
                        <div>
                            <p class="font-black text-xs uppercase text-slate-800">${r.supplier}</p>
                            <p class="text-[9px] text-slate-400 font-bold">${r.date}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-sm ${r.type === 'income' ? 'text-blue-600' : 'text-red-600'}">R${parseFloat(r.totalAmount).toFixed(2)}</p>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });

        // Set default date
        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>

