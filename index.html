import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  deleteDoc, 
  onSnapshot
} from 'firebase/firestore';
import { 
  Camera, 
  History, 
  PlusCircle, 
  Trash2, 
  PieChart, 
  Banknote, 
  X,
  Smartphone,
  ArrowDown,
  ChevronRight
} from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pro-log-business-zar';
const apiKey = ""; 

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('entry');
  const [records, setRecords] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [pendingImage, setPendingImage] = useState(null);
  const [entryType, setEntryType] = useState('income'); 
  const cameraInputRef = useRef(null);

  const [formData, setFormData] = useState({
    amount: '0', 
    yokoAmount: '0', 
    cashAmount: '0', 
    date: new Date().toISOString().split('T')[0],
    supplier: '',
    category: 'Sales',
    notes: ''
  });

  const calculatedTotal = entryType === 'income' 
    ? (parseFloat(formData.yokoAmount || 0) + parseFloat(formData.cashAmount || 0)).toFixed(2)
    : parseFloat(formData.amount || 0).toFixed(2);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error(err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubRecords = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'entries'), (snap) => {
      setRecords(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date)));
    }, (err) => console.error(err));
    return () => unsubRecords();
  }, [user]);

  const handleImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        setPendingImage(ev.target.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const processImage = async () => {
    if (!pendingImage) return;
    setIsProcessing(true);
    
    const systemPrompt = `Extract data from business document image.
    RULES:
    1. Check if it's a "Daily Sales" paper slip or an "Expense" invoice.
    2. If DAILY SALES: 
       - Find the number written immediately to the right of the word "Yoko".
       - Find the number at the bottom that has an arrow drawn underneath it; this is the Grand Total.
       - Set type="income".
    3. If INVOICE/EXPENSE:
       - Find the business name at the top.
       - Find the total amount.
       - Set type="expense".
    
    Return JSON ONLY: {
      "type": "income" | "expense", 
      "supplierName": "string", 
      "yokoAmount": number, 
      "totalAmount": number, 
      "date": "YYYY-MM-DD", 
      "category": "string"
    }`;
    
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            role: "user",
            parts: [{ text: "Process this slip." }, { inlineData: { mimeType: "image/jpeg", data: pendingImage.split(',')[1] } }]
          }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      const result = await response.json();
      const ex = JSON.parse(result.candidates[0].content.parts[0].text);
      
      setEntryType(ex.type);
      setFormData({
        amount: ex.type === 'expense' ? ex.totalAmount?.toString() : '0',
        yokoAmount: ex.yokoAmount?.toString() || '0',
        cashAmount: ex.type === 'income' ? (ex.totalAmount - (ex.yokoAmount || 0)).toString() : '0',
        date: ex.date || new Date().toISOString().split('T')[0],
        supplier: ex.supplierName || (ex.type === 'income' ? 'Daily Sales' : ''),
        category: ex.category || (ex.type === 'income' ? 'Sales' : 'Stock'),
        notes: ''
      });
      setPendingImage(null);
    } catch (err) { 
      console.error(err);
    } finally { setIsProcessing(false); }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'entries'), { 
      ...formData, 
      totalAmount: calculatedTotal,
      type: entryType, 
      createdAt: new Date().toISOString() 
    });
    setFormData({ amount: '0', cashAmount: '0', yokoAmount: '0', date: new Date().toISOString().split('T')[0], supplier: '', category: 'Sales', notes: '' });
    setActiveTab('history');
  };

  return (
    <div className="flex flex-col h-screen bg-slate-50 text-slate-900 max-w-md mx-auto shadow-2xl relative font-sans">
      
      {pendingImage && (
        <div className="absolute inset-0 z-[100] bg-slate-950 flex flex-col items-center p-6 text-white">
          <div className="w-full flex justify-between items-center mb-4">
             <span className="text-[10px] font-black uppercase text-blue-500 tracking-widest italic">Scanning Ledger...</span>
             <button onClick={() => setPendingImage(null)} className="p-2 bg-white/10 rounded-full"><X size={20} /></button>
          </div>
          <div className="flex-1 w-full bg-black rounded-3xl overflow-hidden border border-white/10 flex items-center justify-center">
            <img src={pendingImage} className="max-h-full object-contain" />
          </div>
          <button 
            onClick={processImage} 
            disabled={isProcessing}
            className="w-full mt-6 p-6 rounded-3xl bg-blue-600 font-black uppercase text-xs tracking-widest shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform"
          >
            {isProcessing ? "Reading Document..." : "Confirm Extract"}
          </button>
        </div>
      )}

      <div className="bg-white border-b p-5 flex justify-between items-center sticky top-0 z-10">
        <h1 className="text-xl font-black italic tracking-tighter">PRO-LOG</h1>
        <button onClick={() => cameraInputRef.current.click()} className="flex items-center gap-2 px-6 py-3 rounded-2xl bg-slate-900 text-white font-black text-[10px] uppercase tracking-widest italic shadow-lg active:scale-95">
          <Camera size={16}/> Scan
        </button>
        <input type="file" ref={cameraInputRef} onChange={handleImageSelect} accept="image/*" capture="environment" className="hidden" />
      </div>

      <main className="flex-1 overflow-y-auto p-4 pb-32">
        <div className="flex bg-white p-1 rounded-2xl border border-slate-200 mb-4 shadow-sm">
          <button onClick={() => setEntryType('income')} className={`flex-1 py-3.5 rounded-xl font-black text-[10px] uppercase transition-all ${entryType === 'income' ? 'bg-green-600 text-white shadow-md' : 'text-slate-400'}`}>Income</button>
          <button onClick={() => setEntryType('expense')} className={`flex-1 py-3.5 rounded-xl font-black text-[10px] uppercase transition-all ${entryType === 'expense' ? 'bg-red-600 text-white shadow-md' : 'text-slate-400'}`}>Expense</button>
        </div>

        <form onSubmit={handleSubmit} className="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 space-y-5">
          <div className="space-y-1">
            <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Name / Supplier</label>
            <input 
              className="w-full bg-slate-50 p-4 rounded-xl font-bold text-sm"
              value={formData.supplier}
              onChange={e => setFormData({...formData, supplier: e.target.value})}
              placeholder={entryType === 'income' ? 'Daily Sales' : 'e.g. Sasko'}
            />
          </div>

          {entryType === 'income' ? (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                  <label className="text-[9px] font-black text-blue-500 uppercase flex items-center gap-1"><Smartphone size={10}/> Yoko (Next to text)</label>
                  <div className="flex items-center mt-1">
                    <span className="text-xs font-bold text-blue-600 mr-1">R</span>
                    <input type="number" step="0.01" className="bg-transparent border-none p-0 font-black text-xl text-blue-900 w-full focus:ring-0" 
                      value={formData.yokoAmount} onChange={e=>setFormData({...formData, yokoAmount: e.target.value})} />
                  </div>
                </div>
                <div className="bg-green-50 p-4 rounded-2xl border border-green-100">
                  <label className="text-[9px] font-black text-green-500 uppercase flex items-center gap-1"><ArrowDown size={10}/> Cash (Total - Yoko)</label>
                  <div className="flex items-center mt-1">
                    <span className="text-xs font-bold text-green-600 mr-1">R</span>
                    <input type="number" step="0.01" className="bg-transparent border-none p-0 font-black text-xl text-green-900 w-full focus:ring-0" 
                      value={formData.cashAmount} onChange={e=>setFormData({...formData, cashAmount: e.target.value})} />
                  </div>
                </div>
              </div>
              
              <div className="bg-slate-900 p-4 rounded-2xl flex justify-between items-center shadow-inner">
                <div className="flex items-center gap-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest underline decoration-blue-500/50">Grand Total (Arrow)</label>
                </div>
                <p className="text-white font-black text-2xl tracking-tighter">R{calculatedTotal}</p>
              </div>
            </div>
          ) : (
            <div className="bg-red-50 p-4 rounded-2xl border border-red-100">
              <label className="text-[9px] font-black text-red-500 uppercase">Invoice Total</label>
              <div className="flex items-center mt-1">
                <span className="text-xs font-bold text-red-600 mr-1">R</span>
                <input type="number" step="0.01" className="bg-transparent border-none p-0 font-black text-2xl text-red-900 w-full focus:ring-0" 
                  value={formData.amount} onChange={e=>setFormData({...formData, amount: e.target.value})} />
              </div>
            </div>
          )}

          <div className="grid grid-cols-2 gap-3">
            <input type="date" className="bg-slate-50 p-4 rounded-xl font-bold text-xs" 
              value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} />
            <select className="bg-slate-50 p-4 rounded-xl font-bold text-xs"
              value={formData.category} onChange={e=>setFormData({...formData, category: e.target.value})}>
              <option value="Sales">Sales</option>
              <option value="Stock">Stock</option>
              <option value="Wages">Wages</option>
              <option value="Electricity">Electricity</option>
            </select>
          </div>

          <button type="submit" className={`w-full py-5 rounded-2xl font-black text-white shadow-lg active:scale-95 transition-all ${entryType === 'income' ? 'bg-blue-600' : 'bg-red-600'}`}>
            SAVE {entryType.toUpperCase()}
          </button>
        </form>
      </main>

      <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 bg-white border-t border-slate-100 flex gap-2 z-20">
        {[
          { id: 'entry', icon: PlusCircle, label: 'Add' },
          { id: 'history', icon: History, label: 'Log' },
          { id: 'insights', icon: PieChart, label: 'Stats' }
        ].map(tab => (
          <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex-1 py-4 rounded-2xl flex flex-col items-center transition-all ${activeTab===tab.id ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400'}`}>
            <tab.icon size={20}/>
            <span className="text-[8px] font-black uppercase mt-1 tracking-widest">{tab.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
}

